#!/bin/bash
# vextuClone - Termux Web Cloner Profesional
# Autor: Vextu Android

# Banner bonito
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚       Vextu Android     â”‚"
echo "â”‚       vextuClone        â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

# Crear carpeta de librerÃ­as internas
LIB_DIR="$HOME/.vextuClone-lib"
mkdir -p "$LIB_DIR"

# Descargar librerÃ­as si no existen
[ ! -f "$LIB_DIR/network.sh" ] && \
curl -sL https://raw.githubusercontent.com/WM-HTML/VextuClone/refs/heads/main/network.sh -o "$LIB_DIR/network.sh"

[ ! -f "$LIB_DIR/parser.sh" ] && \
curl -sL https://raw.githubusercontent.com/WM-HTML/VextuClone/refs/heads/main/parser.sh -o "$LIB_DIR/parser.sh"

# Cargar librerÃ­as
source "$LIB_DIR/network.sh"
source "$LIB_DIR/parser.sh"

# URL a clonar
URL="$1"
if [ -z "$URL" ]; then
    echo "ğŸŒ Uso: vextuClone <URL>"
    exit 1
fi

# Limpiar esquema
HOST=$(echo "$URL" | sed -E 's#https?://##; s#/.*##')
SCHEME=$(echo "$URL" | sed -E 's#(https?)://.*#\1#')
PORT=80
[ "$SCHEME" = "https" ] && PORT=443

# Carpeta de destino
DEST="/sdcard/Download/VextuClone/$(echo $HOST | sed 's#/#_#g')"
mkdir -p "$DEST"

echo "ğŸŒ Descargando $URL a $DEST ..."

# FunciÃ³n para descargar con barra de progreso
download_file() {
    local URL="$1"
    local OUT="$2"
    mkdir -p "$(dirname "$OUT")"
    # Barra de progreso
    curl -# -L "$URL" -o "$OUT"
}

# Descargar HTML principal
download_file "$URL" "$DEST/index.html"

# FunciÃ³n para descargar recursos
download_resources() {
    local HTML="$1"
    local DEST="$2"
    local REGEX="$3"
    local TYPE="$4"

    echo "ğŸ“¦ Descargando $TYPE..."
    grep -oP "$REGEX" "$HTML" | while read -r path; do
        [ -z "$path" ] && continue

        # Convertir a URL absoluta
        if [[ "$path" =~ ^/ ]]; then
            FULL_URL="$SCHEME://$HOST$path"
        elif [[ "$path" =~ ^https?:// ]]; then
            FULL_URL="$path"
        else
            FULL_URL="$SCHEME://$HOST/$path"
        fi

        FILE_PATH="$DEST/$(echo $path | sed 's#^/##')"
        download_file "$FULL_URL" "$FILE_PATH"
    done
}

# Descargar CSS, JS, JSON, imÃ¡genes
download_resources "$DEST/index.html" "$DEST" '(?<=href=")[^"]+\.css' "CSS"
download_resources "$DEST/index.html" "$DEST" '(?<=src=")[^"]+\.js' "JS"
download_resources "$DEST/index.html" "$DEST" '(?<=src=")[^"]+\.json' "JSON"
download_resources "$DEST/index.html" "$DEST" '(?<=src=")[^"]+\.(jpg|jpeg|png|gif|svg)' "IMÃGENES"

echo "âœ… Descarga completada en $DEST"
